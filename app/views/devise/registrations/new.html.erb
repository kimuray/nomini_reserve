<div class="container mt-5 mb-5">
  <h2 class="main-text text-center page-heading acount-title regist-title">かんたん登録</h2>
  <p class="regist-explain text-center">お店を見るには無料のかんたん登録が必要となります。</p>

  <%= form_for(resource, as: resource_name, url: registration_path(resource_name)) do |f| %>
    <% if resource.errors.any? %>
      <div class="field form-group center-form">
        <div class="alert alert-danger">
          <ul>
            <%= devise_error_messages! %>
          </ul>
        </div>
      </div>
    <% end %>
    <div class="acount-wrap">
      <div class="sign-up-countainer">
        <div class="field form-group center-form email-form">
          <%= f.email_field :email, placeholder: "メールアドレス(ID)", autofocus: true, class: "form-control text-center" %>
        </div>
      </div>
      <div class="sign-up-alert">
        <p class="sign-up-alert-text">【注意】@docomo.ne.jp, @ezweb.ne.jp などはメールが届かない不具合が報告されております。</p>
        <p class="sign-up-alert-text">【推奨】GoogleやYahooなどのアドレスをご記入ください。</p>
      </div>
      <% if f.object.password_required? %>
        <div class="sign-up-countainer">
          <div class="field form-group center-form password-form">
            <%= f.password_field :password, autocomplete: "off", placeholder: "パスワード：#{@minimum_password_length}文字以上", class: "form-control text-center" %>
          </div>

          <div class="field form-group row center-form">
            <%= f.password_field :password_confirmation, autocomplete: "off", placeholder: "パスワード確認", class: "form-control text-center" %>
          </div>
        </div>
      <% end %>
    </div>

    <% if @subscription.present? %>
      <div class="acount-wrap definitive-registration">
        <div class="field form-group row center-form">
          <%= label :full_name_kana, "フルネーム(全角カナ)", class: "col-sm-4 signup-label" %><br />
          <%= text_field :user, :l_name_kana, placeholder: "セイ", class: "col-sm-4 form-control regist-last-name" %>
          <%= text_field :user, :f_name_kana, placeholder: "メイ", class: "col-sm-4 form-control" %>
        </div>

        <div class="field form-group row center-form">
          <%= label :phone_number, "電話番号", class: "col-sm-4 signup-label" %><br />
          <%= text_field :user, :phone_number, placeholder: "08012345678", class: "col-sm-8 form-control" %>
        </div>
      </div>

      <h2 class="main-text text-center page-heading acount-title card-info-title">クレジットカード登録</h2>
      <p class="regist-explain text-center credit-info-explain">会費・提携店舗での飲食代金は全てオンライン上での決済となります。</p>
      <ul class="reservation-chack text-danger payment-errors">
        <% @user.errors.full_messages.each do |msg| %>
            <li><%= msg %></li>
        <% end %>
      </ul>
      <div class="acount-wrap definitive-registration">
        <div class="field form-group text-center">
          <input type="text" class="form-control number" name="number" maxlength="16" placeholder="カード番号">
        </div>

        <div class="field form-group">
          <div class="row">
            <div class="col-md-4">
              <label for="exp_month" class="expiration-date signup-label">有効期限</label>
            </div>
            <div class="col-md-4">
              <%= select nil, :exp_month, exp_month_range, {}, {class: 'form-control exp_month'}  %>
            </div>
            <div class="col-md-4">
              <%= select nil, :exp_year, exp_year_range, {}, {class: 'form-control exp_year'}  %>
            </div>
          </div>
          <div class="mt-3">
            <input type="text" class="form-control cvc" name="cvc" maxlength="3" placeholder="セキュリティコード（数字3桁）">
          </div>
        </div>
        <p class="regist-explain text-center credit-info-explain mt-3">・ご利用終了後、会計金額がご登録のクレジットカードより引き落とし処理がされます。</p>
        <p class="regist-explain text-center credit-info-explain mb-0">・なお、万が一キャンセルが発生した際は「nominiキャンセルポリシー」に従い、キャンセル金額分をクレジットカードから引き落としさせて頂きます。</p>
      </div>

      <div class="actions form-group text-center">
        <a href="#" id="submit_subscription" class="btn main-btn btn-lg">登録</a>
      </div>
      <%= yield :payjp_form %>
    <% else %>
      <div class="actions text-center mb-3 mt-3">
        <%= f.submit "登録する", class: "btn main-btn btn-lg" %>
      </div>
    <% end %>

  <% end %>
  <div class="sign-up-alert">
    <p class="sign-up-alert-text">※入力頂いたメールアドレスにnominiより認証メールが送信されます。メール記載のURLよりログインください。</p>
  </div>
  <div class="text-center account-sub p-4">
    <% unless session[:sns_flg] %>
      <%- if devise_mapping.omniauthable? %>
        <%- resource_class.omniauth_providers.each do |provider| %>
          <%= link_to omniauth_authorize_path(resource_name, provider), class: "btn facebook-login-button mb-3" do %>
            <i class="fa fa-facebook"></i>Facebookで会員登録
          <% end -%>
          <br />
        <% end -%>
      <% end -%>
    <% end %>
    <%= render "devise/shared/links" %>
  </div>
</div>

<script type="text/javascript">
  (function() {
    var form = $("#new_user"),
      number = form.find('input[name="number"]'),
      cvc = form.find('input[name="cvc"]'),
      exp_month = form.find('select[name="exp_month"]'),
      exp_year = form.find('select[name="exp_year"]');

    $("#submit_subscription").on('click', function() {
      form.find("input[type=submit]").prop("disabled", true);

      var card = {
        number: number.val(),
        cvc: cvc.val(),
        exp_month: exp_month.val(),
        exp_year: exp_year.val()
      };
      Payjp.createToken(card, function(s, response) {
        if (response.error) {
          var message = transrateErrorMessage(response.error.code);
          form.find('.payment-errors').text(message);
          form.find('button').prop('disabled', false);
        }
        else {
          $(".number").removeAttr("name");
          $(".cvc").removeAttr("name");
          $(".exp_month").removeAttr("name");
          $(".exp_year").removeAttr("name");

          var token = response.id;

          form.append($('<input type="hidden" name="payjpToken" />').val(token));
          form.get(0).submit();
        }
      });
    });
  })();

  function transrateErrorMessage(errorCode) {
    switch(errorCode) {
      case 'invalid_number':
        return 'カード番号が不正です';
        break;
      case 'invalid_cvc':
        return 'CVCが不正です';
        break;
      case 'invalid_expiration_date':
        return '有効期限年、月が不正です';
        break;
      case 'invalid_expiry_month':
        return '有効期限月が不正です';
        break;
      case 'invalid_expiry_year':
        return '有効期限年が不正です';
        break;
      case 'expired_card':
        return 'カードの有効期限が切れています';
        break;
      default:
        return 'カード情報が不正です';
        break;
    }
  }
</script>
