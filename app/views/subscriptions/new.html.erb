<div class="container mt-3 payment-info">
  <div class="payment-form">
    <ul class="reservation-chack text-danger">
      <% @user.errors.full_messages.each do |msg| %>
          <li><%= msg %></li>
      <% end %>
    </ul>

    <%= form_for(@subscription) do |f| %>
      <h2 class="main-text text-center page-heading mb-4 mt-4">会員情報の本登録</h2>
      <div class="field form-group row center-form">
        <%= label :full_name_kana, "フルネーム(全角カナ)", class: "col-sm-4 signup-label" %><br />
        <%= text_field :user, :l_name_kana, placeholder: "セイ", class: "col-sm-4 form-control" %>
        <%= text_field :user, :f_name_kana, placeholder: "メイ", class: "col-sm-4 form-control" %>
      </div>

      <div class="field form-group row center-form">
        <%= label :phone_number, "電話番号", class: "col-sm-4 signup-label" %><br />
        <%= text_field :user, :phone_number, placeholder: "08012345678", class: "col-sm-8 form-control" %>
      </div>

      <h2 class="main-text text-center page-heading mb-4 mt-4">クレジットカード登録</h2>

      <div class="field form-group text-center">
        <input type="text" class="form-control number" name="number" maxlength="16" placeholder="カード番号">
      </div>

      <div class="field form-group">
        <div class="row">
          <div class="col-md-3">
            <label for="exp_month" class="expiration-date">有効期限</label>
          </div>
          <div class="col-md-3">
            <%= select nil, :exp_month, exp_month_range, {}, {class: 'form-control exp_month'}  %>
          </div>
          <div class="col-md-3">
            <%= select nil, :exp_year, exp_year_range, {}, {class: 'form-control exp_year'}  %>
          </div>
          <div class="col-md-3">
            <input type="text" class="form-control cvc" name="cvc" maxlength="3" placeholder="CVC">
          </div>
        </div>
      </div>

      <div class="actions form-group text-center">
        <%= f.submit '登録', class: "btn main-btn" %>
      </div>
    <% end %>
  </div>
</div>

<%= content_for :payjp_form do %>
  <script type="text/javascript">
    (function() {
      var form = $("#new_subscription"),
        number = form.find('input[name="number"]'),
        cvc = form.find('input[name="cvc"]'),
        exp_month = form.find('select[name="exp_month"]'),
        exp_year = form.find('input[name="exp_year"]');

      $("#new_subscription").submit(function() {
        form.find("input[type=submit]").prop("disabled", true);

        var card = {
          number: number.value,
          cvc: cvc.value,
          exp_month: exp_month.value,
          exp_year: exp_year.value
        };
        Payjp.createToken(card, function(s, response) {
          if (response.error) {
            form.find('.payment-errors').text(response.error.message);
            form.find('button').prop('disabled', false);
          }
          else {
            $(".number").removeAttr("name");
            $(".cvc").removeAttr("name");
            $(".exp_month").removeAttr("name");
            $(".exp_year").removeAttr("name");

            var token = response.id;

            form.append($('<input type="hidden" name="payjpToken" />').val(token));
            form.get(0).submit();
          }
        });
      });
    })();
  </script>
<% end %>
